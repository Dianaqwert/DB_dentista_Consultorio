<div class="container py-4">
  <div class="mb-3 cuad">
    <h1 class="txt">Gestión de pacientes</h1>
    <p>Actualización, altas y bajas de tratamientos dentales</p>
  </div>

  <div class="row g-5">
    
    <!-- COLUMNA IZQUIERDA: LISTAS -->
    <div class="col-md-3 col-lg-3 order-md-last">
      
      <!-- 1. LISTA DE ACTIVOS -->
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-primary">Tratamientos Activos</span>
        <span class="badge bg-primary rounded-pill">{{ listaTratamientos.length }}</span>
      </h4>
      
      <ul class="list-group mb-3 scroll-lista">
        <!-- Usando @for para activos -->
        @for (t of listaTratamientos; track t.id_tipo_tratamiento) {
          <li class="list-group-item d-flex justify-content-between lh-sm">
            <div>
              <h6 class="my-0">{{ t.nombre }}</h6>
              <small class="text-body-secondary">{{ t.descripcion }}</small>
            </div>
            <div class="text-end">
              <span class="text-body-secondary d-block fw-bold text-success">${{ t.costo }}</span>
              <button class="btn btn-sm btn-outline-danger mt-1" (click)="eliminar(t.id_tipo_tratamiento)">
                  <i class="bi bi-trash"></i> X
              </button>
            </div>
          </li>
        }
        @empty {
          <li class="list-group-item text-center">No hay tratamientos activos.</li>
        }
      </ul>

      <!-- ============================================== -->
      <!-- 2. NUEVA SECCIÓN: TRATAMIENTOS ARCHIVADOS      -->
      <!-- ============================================== -->
      <h4 class="d-flex justify-content-between align-items-center mb-3 mt-5">
        <span class="text-secondary">Histórico (No vigentes)</span>
        <span class="badge bg-secondary rounded-pill">{{ listaInactivos.length }}</span>
      </h4>

      @if (listaInactivos.length === 0) {
          <div class="alert alert-light text-center border">
             <small>No hay tratamientos archivados.</small>
          </div>
      } @else {
          <ul class="list-group mb-3 scroll-lista opacity-75">
            <!-- Usando @for para inactivos -->
            @for (t of listaInactivos; track t.id_tipo_tratamiento) {
              <li class="list-group-item d-flex justify-content-between lh-sm bg-light">
                <div>
                  <h6 class="my-0 text-decoration-line-through text-muted">{{ t.nombre }}</h6>
                  <small class="text-muted fst-italic">Archivado</small>
                </div>
                <div class="text-end">
                  <span class="text-muted d-block small">${{ t.costo }}</span>
                  <i class="bi bi-archive-fill text-secondary"></i>
                </div>
              </li>
            }
          </ul>
      }

    </div>

    <!--COLUMNA DEL MEDIO CON AUMENTO DE TRATAMIENTOS-->
    <div class="col-md-3 col-lg-6 order-md-last">
      <app-estadisticas-tratamientos-d></app-estadisticas-tratamientos-d>
    </div>

    <!-- COLUMNA DERECHA: FORMULARIO REACTIVO -->
    <div class="col-md-3 col-lg-3">
      <h4 class="mb-3">Agregar tratamiento</h4>
      <form [formGroup]="searchForm" (ngSubmit)="guardarTratamiento()">

        <div class="row g-3">
          <!-- Nombre -->
          <div class="col-12">
            <label for="nombre" class="form-label fw-bold">Nombre de tratamiento</label>
            <input type="text" class="form-control" id="nombre" formControlName="nombre"
                   [class.is-invalid]="searchForm.get('nombre')?.invalid && (searchForm.get('nombre')?.dirty || searchForm.get('nombre')?.touched)">
            
            @if (searchForm.get('nombre')?.invalid && (searchForm.get('nombre')?.dirty || searchForm.get('nombre')?.touched)) {
              <div class="invalid-feedback d-block">
                  @if (searchForm.get('nombre')?.hasError('required')) { <div>El nombre es obligatorio.</div> }
                  @if (searchForm.get('nombre')?.hasError('pattern')) { <div>Solo letras y espacios.</div> }
                  @if (searchForm.get('nombre')?.hasError('minlength')) { <div>Mínimo 3 caracteres.</div> }
                  @if (searchForm.get('nombre')?.hasError('repetitive')) { <div class="fw-bold">⚠️ Evita caracteres repetidos consecutivamente.</div> }
              </div>
            }
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label for="descripcion" class="form-label fw-bold">Descripción</label>
            <textarea class="form-control" id="descripcion" formControlName="descripcion" rows="3"
                      [class.is-invalid]="searchForm.get('descripcion')?.invalid && (searchForm.get('descripcion')?.dirty || searchForm.get('descripcion')?.touched)"></textarea>

            @if (searchForm.get('descripcion')?.invalid && (searchForm.get('descripcion')?.dirty || searchForm.get('descripcion')?.touched)) {
              <div class="invalid-feedback d-block">
                  @if (searchForm.get('descripcion')?.hasError('required')) { <div>La descripción es obligatoria.</div> }
                  @if (searchForm.get('descripcion')?.hasError('pattern')) { <div>Solo letras y espacios.</div> }
                  @if (searchForm.get('descripcion')?.hasError('minlength')) { <div>Mínimo 5 caracteres.</div> }
                  @if (searchForm.get('descripcion')?.hasError('repetitive')) { <div class="fw-bold">⚠️ Evita caracteres repetidos consecutivamente.</div> }
              </div>
            }
          </div>

          <!-- Costo -->
          <div class="col-md-8">
            <label for="costo" class="form-label fw-bold">Costo ($)</label>
            <div class="input-group has-validation">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control fw-bold" id="costo" formControlName="costo"
                     [class.is-invalid]="searchForm.get('costo')?.invalid && (searchForm.get('costo')?.dirty || searchForm.get('costo')?.touched)">
              
              @if (searchForm.get('costo')?.invalid && (searchForm.get('costo')?.dirty || searchForm.get('costo')?.touched)) {
                <div class="invalid-feedback d-block">
                   @if (searchForm.get('costo')?.hasError('required')) { <div>El costo es obligatorio.</div> }
                   @if (searchForm.get('costo')?.hasError('pattern')) { <div>Solo números enteros.</div> }
                   @if (searchForm.get('costo')?.hasError('min')) { 
                     <div class="fw-bold">⚠️ El costo debe ser mayor o igual a $500.</div> 
                   }
                </div>
              }
            </div>
          </div>
        </div>

        <hr class="my-4">
        <button class="w-100 btn btn-success btn-lg" type="submit" [disabled]="searchForm.invalid">
          <i class="bi bi-save"></i> Guardar Tratamiento
        </button>
      </form>
      
    </div>
  </div>
</div>

<div class="container py-4">
  <app-pacientes-tratamientos-inactivos-d>
  </app-pacientes-tratamientos-inactivos-d>
</div>
